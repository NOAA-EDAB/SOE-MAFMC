---
title: 'State of the Ecosystem: Mid-Atlantic Bight Snowman'
geometry: left=2cm, right=2cm, top=2cm, bottom=3cm, footskip = .5cm
output:
  pdf_document:
    fig_caption: yes
    includes:
      in_header: latex\header.tex
    latex_engine: xelatex
  html_document:
    df_print: paged
monofont: Calibri
mainfont: Garamond
fontsize: 11pt
---

```{r setup, include=FALSE}

#Default Rmd options
knitr::opts_chunk$set(echo = FALSE, message = FALSE, dev = "cairo_pdf", fig.width = 8, fig.align = 'center')

#Plotting and data libraries
library(ggplot2)
library(dplyr)
library(tidyr)
library(ecodata)
library(here)
library(kableExtra)
library(ggrepel)
library(grid)

#GIS libraries
library(sf)
library(rgdal)
library(raster)
library(rnaturalearth)

#Data directories
image.dir <- here("images")
gis.dir <- here("gis")
```

```{r GIS-setup}

#CRS
crs <- "+proj=longlat +lat_1=35 +lat_2=45 +lat_0=40 +lon_0=-77 +x_0=0 +y_0=0 +datum=NAD83 +no_defs +ellps=GRS80 +towgs84=0,0,0"

#Coastline shapefile
coast <- ne_countries(scale = 10,
                          continent = "North America",
                          returnclass = "sf") %>%
             sf::st_transform(crs = crs)

#EPU shapefile
epu_shp <- readOGR(file.path(gis.dir, "EPU_Extended.shp"), verbose = F) 
crs(epu_shp) <- crs #Assign CRS
epu_shp <- as(epu_shp, "sf") #Turn to sf for use with ggplot
epu_shp <- epu_shp %>% filter(EPU %in% c("MAB","GB","GOM")) #Exclude Scotian Shelf polygon

#Map theme for plotting
theme_map <- function(...) {
  theme(
 # axis.line = element_blank(),
 # axis.ticks = element_blank(),
  panel.grid.major = element_line(colour = "white"),
  panel.grid.minor = element_blank(),
  plot.background = element_rect(fill = "white", color = NA),
  panel.background = element_rect(fill = "white", color = NA),
  legend.background = element_rect(fill = "white", color = NA)
  )
}

theme_ts <- function(...){
    theme(
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      panel.background = element_blank(),
      panel.border = element_rect(colour = "black", fill=NA, size=0.75),
      legend.key = element_blank()
      )
}

#Map line parameters
map.lwd <- 0.4

# Set lat/lon window for maps
xmin = -76
xmax = -66
ymin = 36
ymax = 45
xlims <- c(xmin, xmax)
ylims <- c(ymin, ymax)

  
```



# `Introduction`

The purpose of this report is to provide ecosystem-scale information for fishery managers to consider along with existing species-scale analyses. An overview of ecosystem relationships as represented by a conceptual model helps place more detailed species-level management in context by highlighting relationships between focal species groups organized by Mid Atlantic Fishery Management Council (MAFMC) Fishery Management Plan (FMP), human activities, environmental drivers, habitats, and key ecological links (Fig. \ref{fig:conceptual-model}). Here, human activities indicators in this report, and key paths connecting components and objectives are highlighted.

```{r conceptual-model, out.height="50%", fig.cap="A conceptual model visualizing relationships among Mid-Atlantic Bight ecosystem components. \\label{conceptual-model}"}

knitr::include_graphics(file.path(image.dir, "SOE_MAB_ConceptMod.png"))

```

# `Executive Summary`

We have organized this report using a proposed set of ecosystem-scale objectives (Table \ref{tab:management-objectives}) derived from US legislation and current management practices. We report indicators at the spatial scale of either the Mid-Atlantic Bight (MAB; Fig. \ref{EPU-MAP}) or entire Northeast coast where appropriate. Indicator spatial scale is noted in each section heading (**Do we want to keep this layout?**)

 
```{r management-objectives}

mng_obj <- data.frame("Objective Categories" = c("Seafood Production",
                                                 "Profits","Recreation",
                                                 "Stability","Social & Cultural",
                                                 "Biomass","Productivity",
                                                 "Trophic structure","Habitat"),
"Indicators reported here" = c("Landings by feeding guild","Revenue by feeding guild",
                               "Number of anglers and trips; recreational catch",
                               "Diversity indices (fishery and species)",
                               "Commercial and recreational reliance; social vulnerability",
                               "Biomass or abundance by feeding guild from surveys",
                               "Condition and recruitment of MAFMC managed species",
                               "Relative biomass of feeding guilds, primary productivity",
                               "Estimated habitat occurrence and potential wind-energy interactions")) 

knitr::kable(mng_obj,
      col.names = c("Objective Categories","Indicators reported here"),
      caption = "Established ecosystem-scale objectives in the Mid-Atlantic Bight \\label{management-objectives}",
      align = 'c') %>% 
  kable_styling(latex_options = "striped") %>% 
  column_spec(c(2), width = c("25em")) %>%
  row_spec(0, bold = TRUE)

```

We also report single-species status relative to established objectives and references points. The Mid-Atlantic Council (MAFMC) is meeting objectives at the managed species (i.e. stockwide) level for fishing mortality (F) rates for **inline R code** of **here** and biomass levels for **inline R code** of **here** stocks relative to established reference points (Fig. \ref{stock-status}).

```{r EPU-MAP, fig.height = 5, fig.cap = "The Northeast Large Marine Ecosystem. \\label{EPU-MAP}"}

#Specify data frame with lat/lon locations for labels
epu_labels <- data.frame(EPU = c("Mid-Atlantic\n Bight",
                                 "Gulf of Maine",
                                 "Georges Bank"),
                         latitude = c(40,42.85,41),
                         longitude = c(-72.75,-69,-68.5))

#Map of NE LME
ggplot() +
  geom_sf(data = coast, size = map.lwd) +
  geom_sf(data = epu_shp, fill = "transparent", size = map.lwd) +
  coord_sf(crs = crs, xlim = xlims, ylim = ylims) +
  geom_text(data = epu_labels, aes(x = longitude,
                                    y = latitude,
                                    label = EPU))+
  theme_map() +
  xlab("Longitude") +
  ylab("Latitude")

```

Executive summary continues here..will make figures and come back to text

```{r stock-status, warning=F, fig.cap = "Summary of single species status for MAFMC and jointly managed stocks. \\label{stock-status}"}

#Get data, spread for plotting, and filter
stock_status <- ecodata::stock_status %>%
  spread(.,Var,Value) %>% 
  filter(Council %in% c("MAFMC","Both"))

#Plot constants
y.max <- 1.75
x.max <- 2.6

#A dataframe that defines custom legend for stocks with unknown status
unknown <- data.frame(text = c("Unknown Status", "Longfin",
                                "Ilex", "N. Goosefish", "S. Goosefish"),
                      x = rep(0.9*x.max,5),
                      y = seq(0.93*y.max,1.2,-.1))

#Plotting code
ggplot(data = stock_status) +
  geom_vline(xintercept = 1, linetype = "dotted")+
  geom_vline(xintercept = 0.5, linetype = "dashed")+
  geom_hline(yintercept = 1, linetype = "dashed") +
  geom_point(aes(x = B.Bmsy,
                 y = F.Fmsy,
                 color = Council)) +
  geom_text_repel(aes(x = B.Bmsy, #geom_text_repel auto-jitters text around points
                      y = F.Fmsy,
                      label = Code,
                      color = Council), show.legend = FALSE,nudge_y = 0.05, nudge_x = 0.05) +
  scale_color_manual(values = c("purple","blue"), #Change legend labels for clarity
                     name = "Managed by",
                     breaks = c("Both","MAFMC"),
                     labels = c("MAFMC/NEFMC","MAFMC"))+
  ylim(0,y.max) +
  xlim(0,x.max) +
  geom_text(data = unknown, aes(x = x, y = y, label = text), #Custom legend for unknown stock status
            size = c(4.75,rep(4,4)),
            color = c("black",rep("blue",2), rep("purple",2))) +
  annotate("rect", xmin = 0.8*x.max,
           xmax = x.max,
           ymin = 0.65*y.max,
           ymax = 0.905*y.max,
           alpha = 0.1) +
  xlab(expression(~B/B[msy])) +
  ylab(expression(~F/F[msy])) +
  theme_ts()
```


# `Changes for 2019`
This section will likely be included as an appendix.

Many metrics have been developed to aggregate species into functional groups. Similar groupings have been developed for previous editions of this report, which we refer to as feeding guilds. We have continued to improve upon these groupings to better reflect ecological reality, and show feeding guilds with key composite species in Table \ref{tab:species-groupings}.
**FYI these are last year's groupings**

```{r species-groupings, warning=F}

spec_group <- data.frame(Group = c("Apex Predator (Highest trophic level)",
                                   "Piscivore (Eat fish)",
                                   "Planktivore (Eat plankton)",
                                   "Benthivore (Eat bottom dwellers)",
                                   "Benthos (Filter feeders)"),
                         N = c(4, 23, 16, 25, 9),
                         Major.species = c("shark (Unc.), swordfish, yellowfin and bluefin tuna",
                                            "spiny dogfish, summer flounder, bluefish, striped bass, weakfish,
                                            monkfish, winter and thorny skates, silver and offshore hake,
                                            Atlantic cod and halibut, fourspot flounder",
                                            "Atlantic and blueback herring, alewife, shad, menhaden, cusk,
                                            Atlantic mackerel, butterfish, blackbelly rosefish, sculpins, lumpfish,
                                            northern searobin, northern sand lance, northern shortfin and
                                            longfin squid",
                                            "black sea bass, scup, tilefish, tautog, cunner, blue crab, red crab,
                                            lobster, ocean pout, haddock, yellowtail, winter, and witch
                                            flounders, barndoor skate, American plaice, other crabs",
                                            "scallops, surfclam, quahog, mussels, whelks, conchs, sand dollars
                                            and urchins"))

knitr::kable(spec_group,
      col.names = c("Group","N species", "Major species in the group"),
      caption = "Mid-Atlantic Bight feeding guilds listed with key species. \\label{species-group}",
      align = 'c') %>% 
  kable_styling(latex_options = "striped") %>%
  column_spec(c(1,2,3), width = c("10em","5em","25em")) %>% 
  row_spec(0, bold = TRUE)

```


