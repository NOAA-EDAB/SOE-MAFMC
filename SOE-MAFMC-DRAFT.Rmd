---
title: 'State of the Ecosystem: Mid-Atlantic Bight Snowman'
geometry: left=2cm, right=2cm, top=2cm, bottom=3cm, footskip = .5cm
output:
  pdf_document:
    fig_caption: yes
    includes:
      in_header: latex/header.tex
    latex_engine: xelatex
  html_document:
    df_print: paged
monofont: Calibri
mainfont: Garamond
fontsize: 11pt
header-includes: 
   - \usepackage{wrapfig}
---

```{r setup, include=FALSE}

#Default Rmd options
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      dev = "cairo_pdf",
                      fig.align = 'center',
                      eval.after = "fig.cap") #allows for inserting R code into captions

#Plotting and data libraries
library(ggplot2)
library(dplyr)
library(tidyr)
library(ecodata)
library(here)
library(kableExtra)
library(ggrepel)
library(stringr)
library(grid)

#GIS libraries
library(sf)
library(rgdal)
library(raster)
library(rnaturalearth)

#Data directories
image.dir <- here("images")
gis.dir <- here("gis")

#General inline text input for report

#Council
council <- "Mid-Atlantic Fishery Management Council"
council_abbr <- "MAFMC"

#Region identifiers
epu <- "Mid-Atlantic Bight"
epu_abbr <- "MAB"
region <- "Mid-Atlantic"
region_abbr <- substring(epu_abbr,1,2) #Some commercial data organized by "MA" or "NE" regions, not by EPU 

```

```{r GIS-setup}

#CRS
crs <- "+proj=longlat +lat_1=35 +lat_2=45 +lat_0=40 +lon_0=-77 +x_0=0 +y_0=0 +datum=NAD83 +no_defs +ellps=GRS80 +towgs84=0,0,0"

#Coastline shapefile
coast <- ne_countries(scale = 10,
                          continent = "North America",
                          returnclass = "sf") %>%
             sf::st_transform(crs = crs)

#State polygons
ne_states <- ne_states(country = "united states of america",
                                      returnclass = "sf") %>%
  sf::st_transform(crs = crs)

#EPU shapefile
epu_sf <- ecodata::epu_sf %>% 
  filter(EPU %in% c("MAB","GB","GOM"))

#Map line parameters
map.lwd <- 0.4

# Set lat/lon window for maps
xmin = -76
xmax = -66
ymin = 36
ymax = 45
xlims <- c(xmin, xmax)
ylims <- c(ymin, ymax)

#Time series constants
shade.alpha <- 0.3
shade.fill <- "lightgrey"
lwd <- 1
pcex <- 2
trend.alpha <- 0.5
trend.size <- 2
hline.size <- 1
hline.alpha <- 0.35
hline.lty <- "dashed"
label.size <- 5
hjust.label <- 1.5
feeding.guilds <- c("Apex Predator","Piscivore","Planktivore","Benthivore","Benthos")

#Function for custom ggplot facet labels
label <- function(variable,value){
  return(facet_names[value])
}
```


# `Introduction`

The purpose of this report is to provide ecosystem-scale information for fishery managers to consider along with existing species-scale analyses. An overview of ecosystem relationships as represented by a conceptual model helps place more detailed species-level management in context by highlighting relationships between focal species groups organized by the `r council` (`r council_abbr`) Fishery Management Plan (FMP), human activities, environmental drivers, habitats, and key ecological links (Fig. \ref{fig:conceptual-model}). Here, human activities indicators in this report, and key paths connecting components and objectives are highlighted.

```{r conceptual-model, out.height="50%", fig.cap=paste0("A conceptual model visualizing relationships among ",epu," ecosystem components. \\label{conceptual-model}")}

if (epu_abbr == "MAB"){
  knitr::include_graphics(file.path(image.dir, "SOE_MAB_ConceptMod.png"))
} else {
  knitr::include_graphics(file.path(image.dir, 'ne_conceptual_model.pdf'))
}

```

# `Executive Summary`

We have organized this report using a proposed set of ecosystem-scale objectives (Table \ref{tab:management-objectives}) derived from US legislation and current management practices. We report indicators at the spatial scale of either the `r epu` (`r epu_abbr`; Fig. \ref{EPU-MAP}) or entire Northeast coast where appropriate. Indicator spatial scale is noted in each section heading (**Do we want to keep this layout?**)

 
```{r management-objectives}

mng_obj <- data.frame("Objective Categories" = c("Seafood Production",
                                                 "Profits","Recreation",
                                                 "Stability","Social & Cultural",
                                                 "Biomass","Productivity",
                                                 "Trophic structure","Habitat"),
"Indicators reported here" = c("Landings by feeding guild","Revenue by feeding guild",
                               "Number of anglers and trips; recreational catch",
                               "Diversity indices (fishery and species)",
                               "Commercial and recreational reliance; social vulnerability",
                               "Biomass or abundance by feeding guild from surveys",
                               "Condition and recruitment of MAFMC managed species",
                               "Relative biomass of feeding guilds, primary productivity",
                               "Estimated habitat occurrence and potential wind-energy interactions"))

knitr::kable(mng_obj,
      col.names = c("Objective Categories","Indicators reported here"),
      caption = "Established ecosystem-scale objectives in the Mid-Atlantic Bight \\label{management-objectives}",
      align = 'c',
      booktabs = T) %>%
 # kable_styling(latex_options = "striped") %>%
  column_spec(c(2), width = c("25em")) %>%
  row_spec(0, bold = TRUE)
```

We also report single-species status relative to established objectives and references points. The `r council_abbr` is meeting objectives at the managed species (i.e. stockwide) level for fishing mortality (F) rates for **inline R code** of **here** and biomass levels for **inline R code** of **here** stocks relative to established reference points (Fig. \ref{stock-status}).

```{r EPU-MAP, fig.cap = "The Northeast Large Marine Ecosystem. \\label{EPU-MAP}", fig.width = 3.4, fig.asp = 1.25}

#Specify data frame with lat/lon locations for labels
epu_labels <- data.frame(EPU = c("Mid-Atlantic\n Bight",
                                 "Gulf of Maine",
                                 "Georges Bank"),
                         latitude = c(40,42.85,41),
                         longitude = c(-72.7,-69,-68.5))

#Map of NE LME
ggplot() +
  geom_sf(data = coast, size = map.lwd) +
  geom_sf(data = epu_sf, fill = "transparent", size = map.lwd) +
  coord_sf(crs = crs, xlim = xlims, ylim = ylims) +
  geom_text(data = epu_labels, aes(x = longitude,
                                    y = latitude,
                                    label = EPU),
            size = 3.2)+
  theme_map() +
  xlab("Longitude") +
  ylab("Latitude")

```

Executive summary continues here..will make figures and come back to text

```{r stock-status, warning=F, fig.cap = paste0("Summary of single species status for ",council_abbr," and jointly managed stocks. \\label{stock-status}"), fig.width = 7.5, fig.asp = 0.5}

#Get data, spread for plotting, and filter
stock_status <- ecodata::stock_status %>%
  spread(.,Var,Value) %>% 
  filter(Council %in% c(council_abbr,"Both"))

#Plot constants
y.max <- 1.75
x.max <- 2.6

#A dataframe that defines custom legend for stocks with unknown status
if (council_abbr == "MAFMC"){
  unknown <- data.frame(text = c("Unknown Status", "Longfin",
                                "Ilex", "N. Goosefish", "S. Goosefish"),
                      x = rep(0.9*x.max,5),
                      y = seq(0.93*y.max,1.2,-.1))
} else {
  unknown <- NULL
}


#Plotting code
ggplot(data = stock_status) +
  geom_vline(xintercept = 1, linetype = "dotted")+
  geom_vline(xintercept = 0.5, linetype = "dashed")+
  geom_hline(yintercept = 1, linetype = "dashed") +
  geom_point(aes(x = B.Bmsy,
                 y = F.Fmsy,
                 color = Council)) +
  geom_text_repel(aes(x = B.Bmsy, #geom_text_repel auto-jitters text around points
                      y = F.Fmsy,
                      label = Code,
                      color = Council), show.legend = FALSE,nudge_y = 0.05, nudge_x = 0.05) +
  scale_color_manual(values = c("purple","blue"), #Change legend labels for clarity
                     name = "Managed by",
                     breaks = c("Both","MAFMC"),
                     labels = c("MAFMC/NEFMC","MAFMC"))+
  ylim(0,y.max) +
  xlim(0,x.max) +
  geom_text(data = unknown, aes(x = x, y = y, label = text), #Custom legend for unknown stock status
            size = c(4.75,rep(4,4)),
            color = c("black",rep("blue",2), rep("purple",2))) +
  annotate("rect", xmin = 0.8*x.max,
           xmax = x.max,
           ymin = 0.65*y.max,
           ymax = 0.905*y.max,
           alpha = 0.1) +
  xlab(expression(~B/B[msy])) +
  ylab(expression(~F/F[msy])) +
  theme_ts()
```


# `Changes for 2019`
This section will likely be included as an appendix.

Many metrics have been developed to aggregate species into functional groups. Similar groupings have been developed for previous editions of this report, which we refer to as feeding guilds. We have continued to improve upon these groupings to better reflect ecological reality, and show feeding guilds with key composite species in Table \ref{tab:species-groupings}.
**FYI these are last year's groupings and specific to MAB**

```{r species-groupings, warning=F}

spec_group <- data.frame(Group = c("Apex Predator (Highest trophic level)",
                                   "Piscivore (Eat fish)",
                                   "Planktivore (Eat plankton)",
                                   "Benthivore (Eat bottom dwellers)",
                                   "Benthos (Filter feeders)"),
                         N = c(4, 23, 16, 25, 9),
                         Major.species = c("shark (Unc.), swordfish, yellowfin and bluefin tuna",
                                            "spiny dogfish, summer flounder, bluefish, striped bass, weakfish,
                                            monkfish, winter and thorny skates, silver and offshore hake,
                                            Atlantic cod and halibut, fourspot flounder",
                                            "Atlantic and blueback herring, alewife, shad, menhaden, cusk,
                                            Atlantic mackerel, butterfish, blackbelly rosefish, sculpins, lumpfish,
                                            northern searobin, northern sand lance, northern shortfin and
                                            longfin squid",
                                            "black sea bass, scup, tilefish, tautog, cunner, blue crab, red crab,
                                            lobster, ocean pout, haddock, yellowtail, winter, and witch
                                            flounders, barndoor skate, American plaice, other crabs",
                                            "scallops, surfclam, quahog, mussels, whelks, conchs, sand dollars
                                            and urchins"))

knitr::kable(spec_group,
      col.names = c("Group","N species", "Major species"),
      caption = "Mid-Atlantic Bight feeding guilds listed with key species. \\label{species-group}",
      align = 'c',
      booktabs = T) %>% 
  #kable_styling(latex_options = "striped") %>%
  column_spec(c(1,2,3), width = c("8em","5em","25em")) %>% 
  row_spec(0, bold = TRUE)

```

# `Human Dimensions` 

```{r human-dimension-inline-text}
#Set parameters to generate inline results for human dimensions------------------------------------------

#The most recent year landings data are available
latest_landings_data <- 2017

#Pick a species name to find its feeding guild.
example_common_name <- "BLUE CRAB"
feeding_guild <- ecodata::species_groupings %>%
  filter(COMNAME == example_common_name) %>% pull(SOE_18)

#Make lowercase for inclusion in text
example_common_name <- tolower(example_common_name)

#Create a table of proportion of managed landings and revenues (displayed in next code chunk)
land_rev_prop <- ecodata::comdat %>%
  filter(str_detect(Var, paste0(council_abbr," managed species - Landings prop|",council_abbr," managed species - Revenue prop")), #find landings and revenue proportions
         Time == latest_landings_data, #get latest year
         EPU == epu_abbr,
         !str_detect(Var, "Other")) %>% #discard "other" category
  mutate(Var = ifelse(str_detect(Var,"Revenue"), #Rename to shorten
                      paste(word(Var), "Revenue"),
                      paste(word(Var), "Landings"))) %>% 
  separate(., Var, into = c("Group","Metric")) %>% #Separate and spread for reporting table
  mutate(Value = round(Value,2)) %>% 
  spread(.,Metric,Value) %>% 
  dplyr::select(-Time, -Units, -EPU) %>% 
  arrange(match(Group, c("Piscivore","Planktivore","Benthivore","Benthos"))) #arrange in chosen order

#Find most recent proportion of landings/revenue for CHOSEN SPECIES
inline_landings <- land_rev_prop %>% filter(Group == feeding_guild) %>% pull(Landings)
inline_revenue <- land_rev_prop %>% filter(Group == feeding_guild) %>% pull(Revenue)

  
```

## Seafood production (`r epu_abbr`)

Seafood production is a stated goal of optimal fishery management as part of the defintion of "benefits to the nation" under MSA. Both commercial and recreational fishing contributes to seafood production, the latter for personal consumption, and indicators for each of these human activities track management performance against this objective. 

The `r council_abbr` only manages a portion of the total commercial landings that occur in the `r epu_abbr` region. For example, `r example_common_name`s represent a substantial portion of `r feeding_guild` landings. For the year `r latest_landings_data`, `r council_abbr` managed species accounted for `r round(inline_landings * 100)`% of the Benthivore landings and `r round(inline_revenue * 100)`% of the revenue generated from those landings in the `r epu_abbr`. These proportions are highlighted below in Table \ref{tab:land-rev-props}.

```{r land-rev-props}

knitr::kable(land_rev_prop,
      caption = paste0("Proportion of landings and revenue derived from managed species in the ",region," region. \\label{land-rev-props}"),
      align = 'c',
      booktabs = T) %>% 
  kable_styling(latex_options = "striped") %>%
  row_spec(0, bold = TRUE)

```

Figure \ref{comm-landings} shows the removals for human consumption of trophic groups including all species landed in the `r epu_abbr` as well as the subset of those removals managed by the `r council_abbr`. 

```{r comm_landings,fig.height=6.5, warning=F, fig.width = 5, fig.cap = paste0(council_abbr," managed species landings (red) and total commercial landings (black) by feeding guild. \\label{comm-landings}")}
#Get data for plotting

#Managed landings
managed_landings <- ecodata::comdat  %>%
  filter(str_detect(Var, paste0(council_abbr," managed species - Landings weight|JOINT managed species - Landings weight")),
         !str_detect(Var, "Other"),
         Time >= 1986,
         EPU == epu_abbr)

#Total landings
total_landings <- ecodata::comdat  %>%
  filter(!str_detect(Var, "managed species"),
         !str_detect(Var, "Other"),
         str_detect(Var, "Landings"),
         Time >= 1986,
         EPU == epu_abbr)

#Assign feeding guild column for plotting with ggplot
landings <- rbind(managed_landings, total_landings) %>%
  mutate(feeding.guild = str_extract(Var,paste(feeding.guilds, collapse = "|")),
         grouping = factor(ifelse(str_detect(Var,council_abbr), "managed",
                                  ifelse(str_detect(Var, "JOINT"), "joint","total"))),
         Var = paste(word(feeding.guild), grouping)) %>% 
  mutate(feeding.guild = factor(feeding.guild, levels = feeding.guilds))

#Add JOINT landings to MANAGED landings and remove
landings[landings$Var ==  "Piscivore managed",]$Value <- landings[landings$Var ==  "Piscivore managed",]$Value + landings[landings$Var ==  "Piscivore joint",]$Value
landings <- landings %>%
  filter(Var != "Piscivore joint")  %>% 
  group_by(Var) %>% 
  mutate(hline = mean(Value))
  
#Define constants for figure plot
x.shade.max <- max(landings$Time)
x.shade.min <- x.shade.max - 9 
series.col <- c("indianred","black")

#Create dataframe for label locations
label_loc <- landings %>%
  group_by(feeding.guild) %>%
  dplyr::summarise(yloc = max(Value)*0.95,
                   xloc = min(Time)) %>% 
  mutate(label = LETTERS[1:5])

#facet names for titles
facet_names <- list("Apex predators" = expression("Apex predators"),
                    "Piscivores" = expression("Piscivores"),
                    "Planktivores" = expression("Planktivores"),
                    "Benthivores" = expression("Benthivores"),
                    "Benthos" = expression("Benthos"))

ggplot(data = landings,aes(x = Time, y = Value, color = grouping)) +
  
  #Highlight last ten years
  annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  
  #Test for trend and add lines
  geom_gls(aes(x = Time, y = Value,
               group = Var)) +
  
  #Add time series
  geom_line(size = lwd) +
  geom_point(size = pcex) +
  scale_color_manual(values = series.col, aesthetics = "color")+
  guides(color = FALSE) +
  geom_hline(aes(yintercept = hline,
                 group = Var,
                 size = grouping),
             size = hline.size,
             alpha = hline.alpha,
             linetype = hline.lty)+

  #Facet 
  facet_wrap(feeding.guild~.,scales = "free_y", labeller = label, ncol = 1) +
  
  #Axis and theme
  scale_y_continuous(labels = function(l){trans = l / 1000})+
  scale_x_continuous(breaks = seq(1985, 2015, by = 5), expand = c(0.01, 0.01)) +
  ylab(expression("Landings, 10"^3*"metric tons")) +
  theme_facet() +
  theme(strip.text=element_text(hjust=0))


```

Total commercial seafood landings from all species and from `r council_abbr` managed species in the `r epu_abbr` indicate total seafood production. Years prior to 1977 included foreign landings, so we began the time series in 1986 **Why not 1978?**. Aggregated landings, as shown in Figure \ref{total-landings}, are drawn from domestic fisheries only. In the `r region`, *there has been a significant recent decrease in seafood landings, indicating high risk to regional domestic seafood production* **Specific to MAB**. 

```{r total-landings, fig.cap = paste0("Total commercial seafood landings (black) shown with ",region," managed seafood landings (red). \\label{total-landings}"), fig.width = 5, fig.asp = 0.45}
total_landings_agg <- total_landings %>%
  group_by(Time) %>%
  dplyr::summarise(Value = sum(Value)) %>% 
  mutate(Var = "Total",hline = mean(Value))
managed_landings_agg <- managed_landings %>%
  group_by(Time) %>%
  dplyr::summarise(Value = sum(Value)) %>% 
  mutate(Var = "Managed",hline = mean(Value))

landings_agg <- rbind(total_landings_agg, managed_landings_agg)


ggplot(data = landings_agg)+
  
  #Highlight last ten years
  annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  geom_gls(aes(x = Time, y = Value,
               group = Var),
             alpha = trend.alpha, size = trend.size) +
  geom_line(aes(x = Time, y = Value, color = Var), size = lwd) +
  geom_point(aes(x = Time, y = Value, color = Var), size = pcex) +

  scale_y_continuous(labels = function(l){trans = l / 1000})+
  scale_x_continuous(breaks = seq(1985, 2015, by = 5), expand = c(0.01, 0.01)) +
  scale_color_manual(values = series.col, aesthetics = "color")+
  guides(color = FALSE) +
  ylab(expression("Landings (10"^3*"metric tons)")) +

  geom_hline(aes(yintercept = hline,
               
               color = Var),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
    theme_ts()

```

Recreational seafood landings (as opposed to total landings that include catch and release shown by other indicators) were used to assess food use of recreationally caught fish in the `r region`. These data are shown in Figure \ref{rec-landings}, *where a negative long-term trend is driven by high catch prior to 1990. Recreational harvest remains near the long-term mean after 1990, and is likely increasing.* **Specific to MAB**

```{r rec-landings, fig.cap = paste0("Total recreational seafood harvest in the ",region," region. \\label{rec-landings}"), fig.width = 5, fig.asp = 0.45}

landings_rec <- ecodata::recdat %>% 
  filter(EPU == region_abbr,
         Var == "Recreational Seafood") %>% 
  mutate(hline = mean(Value))

series.col <- "black"

ggplot(data = landings_rec)+
  
  #Highlight last ten years
  annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  geom_gls(aes(x = Time, y = Value,
               group = Var),
             alpha = trend.alpha, size = trend.size) +
  geom_line(aes(x = Time, y = Value, color = Var), size = lwd) +
  geom_point(aes(x = Time, y = Value, color = Var), size = pcex) +

  scale_y_continuous(labels = function(l){trans = l / 1000000})+
  scale_x_continuous(breaks = seq(1985, 2015, by = 5), expand = c(0.01, 0.01)) +
  scale_color_manual(values = series.col, aesthetics = "color")+
  guides(color = FALSE) +
  ylab(expression("Fish caught (10"^6*"n)")) +

  geom_hline(aes(yintercept = hline,
               
               color = Var),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
  theme_ts()

```

## `Commercial Fishery Revenue (`r epu_abbr`)`

This indicator links the human activity of commercial fishing to the profits objective. The Bennet Indicator, as shown in Figure \ref{bennet}, shows changes in revenue as a composite of price and volume of catch in the `r region`. For example, in the year 2010, the volume of catch relative to the long-term mean was low, and price was relatively high. Combined, these data indicate the "pull" of catch price and volume on revenue changes. Here we show the indicator for all species caught in the `r region`, and a feeding guild level breakdown of these data is available in the Appendix. 

```{r bennet, fig.cap = paste0("Revenue change from the long-term mean in 2015 dollars (black), Price (PI), and Volume Indicators (VI) for commercial landings in the ",region,". \\label{bennet}"), fig.height = 3}

#Filter data into two dataframes for plotting
indicators <- ecodata::bennet %>% 
  filter(EPU == epu_abbr,
         Var %in% c("VI EPU aggregate",
                    "PI EPU aggregate")) %>% 
  mutate(Var, Var = plyr::mapvalues(Var, from = c("VI EPU aggregate","PI EPU aggregate"),
                                    to = c("Volume","Price")))

revchange <- ecodata::bennet %>% 
  filter(EPU == epu_abbr,
         Var %in% c("REVCHANGE EPU aggregate"))

#custom bar fill color (color-blind friendly)
ind_fill <- c("#a6cee3", "#b2df8a")

#limits
y.lim <- c(-450,450)

#plot
ggplot(data = indicators)+
  
  #Highlight last ten years
  annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf)+
  
  geom_bar(aes(x=Time, y= Value, fill = Var), stat="identity")+
  scale_fill_manual(name = "Indicators", values = ind_fill) +
  geom_line(data = revchange, aes(x = Time, y = Value, colour="$"))+
  scale_colour_grey(name ="Revenue Change") +
  ggtitle("Revenue Change ($2015), Price (PI) and Volume Indicator (VI)")+
  labs(y="Value $1,000,000 ($2015)") +
  scale_x_continuous(breaks = seq(1985, 2015, by = 5), expand = c(0.01, 0.01)) +
  scale_y_continuous(breaks = seq(y.lim[1], y.lim[2], by = 100), limits = y.lim, expand = c(0.01, 0.01)) +
  theme_ts() +
  theme(title = element_text(size = 10))

```

## Ecosystem-wide and Managed Species Total Revenue (`r epu_abbr`)

**Should "other" landings be included here?**
**Note no MAFMC managed apex predators**
```{r comm-revenue, fig.cap = "Total revenue for the region (black) and revenue from MAFMC managed species (red). \\label{comm-rev}", fig.width = 5, fig.asp = 0.45}

#Filtering and aggregation step
rev_agg <- ecodata::comdat %>% 
  filter(str_detect(Var, "Revenue"),
         !str_detect(Var, "prop|Other|NEFMC"), #Remove proportions, "Other" category species, NEFMC managed species in MAB
         EPU == epu_abbr,
         Time >= 1986) %>% 
  mutate(Status = ifelse(str_detect(Var, "Revenue weight"), 
                         "Managed","Total")) %>% #Create groups for aggregation
  group_by(Status, Time) %>% 
  dplyr::summarise(Total = sum(Value)) %>% 
  group_by(Status) %>% 
  mutate(hline = mean(Total))

series.col <- c("indianred","black")

#Plotting
ggplot(data = rev_agg) +
  
  #Highlight last ten years
  annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf)+  
  
  #lines
  geom_gls(aes(x = Time, y = Total,
               group = Status),
             alpha = trend.alpha, size = trend.size) +
  geom_line(aes(x = Time, y = Total, color = Status), size = lwd) +
  geom_point(aes(x = Time, y = Total, color = Status), size = pcex) +

  #axes
  scale_y_continuous(labels = function(l){trans = l / 1000000})+
  scale_x_continuous(breaks = seq(1985, 2015, by = 5), expand = c(0.01, 0.01)) +
  scale_color_manual(values = series.col, aesthetics = "color")+
  guides(color = FALSE) +
  ylab(expression("Revenue (10"^6*"USD)")) +
  geom_hline(aes(yintercept = hline,
               color = Status),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
  theme_ts()

rev_inline <- rev_agg %>% 
  dplyr::select(Status, Time, Total) %>% 
  spread(.,Status, Total) %>% 
  mutate(percent_managed = round(Managed/Total * 100)) %>% 
  filter(Time > latest_landings_data - 5, Time <= latest_landings_data) %>% 
  pull(percent_managed)

min_rev_perc <- min(rev_inline)
max_rev_perc <- max(rev_inline)
```


Average total revenue from `r council_abbr` managed species ranges from `r min_rev_perc`-`r max_rev_perc`% of total revenue from commercial fishing in the `r region` region over the last 5 years (Fig. \ref{comm-rev}).

## Commercial Fleet Diversity (coastwide, `r region` permits)

Maintaining diversity can provide the capacity to adapt to change at the ecosystem level for dependent fishing communities, and can address objectives related to stability. Diversity estimates have been developed for fleets and species landed by vessels with `r region` permits (Fig. \ref{comm-div}). A fleet is defined here as the combination of gear code (Scallop Dredge, Other Dredge, Gillnet, Hand Gear, Longline, Bottom Trawl, Midwater Trawl, Pot, Purse Seine, or Clam Dredge) and vessel length category (<30 ft., 30-50 ft., 50 to 75 ft., and >75 ft.). The metric presented assesses the diversity of the overarching fleet, in terms of all revenue generated. 

A declining trend in diversity indicates reliance on either a smaller number of resources, or a less diverse pool of resources. The diversity metric alone cannot distinguish whether specialization (by choice) or stovepiping (choices constrained) is occurring in the Northeast Large Marine Ecosystem. 


```{r comm-div, fig.width = 5, fig.asp = .7, fig.cap = paste0("Fleet diversity (A) and fleet count (B) in the ",region,". \\label{comm-div}")}
comm_div <- ecodata::commercial_div %>% 
  filter(EPU == region_abbr) %>% 
  group_by(Var) %>% 
  mutate(hline = mean(Value))


series.col = c("black")

fleet_count <- comm_div %>% 
  filter(Var == "Fleet count") %>% 
  ggplot() + 
 #Highlight last ten years
  annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +

  geom_line(aes(x = Time, y = Value, color = Var), size = lwd) +
  geom_point(aes(x = Time, y = Value, color = Var), size = pcex) +

  scale_x_continuous(expand = c(0.01, 0.01)) +
  scale_color_manual(values = series.col, aesthetics = "color")+
  guides(color = FALSE) +
  ylab(expression("Fleet count (n)")) +
  xlab("")+
  geom_hline(aes(yintercept = hline,
               color = Var),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
  theme_ts()

fleet_div <- comm_div %>% 
  filter(Var == "Fleet diversity in revenue") %>% 
  ggplot() + 
 #Highlight last ten years
  annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +

  geom_line(aes(x = Time, y = Value, color = Var), size = lwd) +
  geom_point(aes(x = Time, y = Value, color = Var), size = pcex) +

  scale_x_continuous(expand = c(0.01, 0.01)) +
  scale_color_manual(values = series.col, aesthetics = "color")+
  guides(color = FALSE) +
  ylab(expression("Fleet diversity")) +

  geom_hline(aes(yintercept = hline,
               color = Var),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
 theme_ts()

cowplot::plot_grid(fleet_count, fleet_div, ncol = 1, align = "hv") + 
  theme(plot.margin = unit(c(0.1, 0, 0, 0), "cm"))

```

Another diversity index is the average effective Shannon index for species revenue at the permit level (Fig. \ref{spec-div}), for all permits landing any amount of `r council_abbr` FMP species within a year **(including Monkfish and Spiny Dogfish)**. Although the exact value of effective Shannon index is relatively uninformative, the major change in diversity seems to have occurred in the late 1990s, with much of the recent ndex being relatively stable. 

```{r spec-div, fig.width = 5, fig.asp = 0.45, fig.cap = paste0("Species revenue diversity in the ",region,". \\label{spec-div}")}
comm_div %>% 
  filter(Var == "Permit revenue species diversity") %>% 
  ggplot() + 
 #Highlight last ten years
  annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  geom_gls(aes(x = Time, y = Value,
               group = Var),
             alpha = trend.alpha, size = trend.size) +
  geom_line(aes(x = Time, y = Value, color = Var), size = lwd) +
  geom_point(aes(x = Time, y = Value, color = Var), size = pcex) +

  scale_x_continuous(expand = c(0.01, 0.01)) +
  scale_color_manual(values = series.col, aesthetics = "color")+
  guides(color = FALSE) +
  ylab(expression("Diversity")) +
  geom_hline(aes(yintercept = hline,
               color = Var),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
 theme_ts()
```

## Offshore wind development

## Recreational Opportunities (`r region` states)


Providing recreational opportunities is a stated foal of optimal fishery management as part of the definition of "benefits to the nation" under MSA. Recreational fishing is important in the `r region` region, with *many coastal communities having high recreational dependence.* 

```{r recdat, fig.width = 5, fig.asp = .9, fig.cap = paste0("Recreational effort in terms of days fished (A), recreational effort diversity (B), and number of recreational anglers (c) in the ",region,". \\label{recdat}")}
recdat <- ecodata::recdat %>% 
  filter(EPU == region_abbr) %>% 
  group_by(Var) %>% 
  mutate(hline = mean(Value))

series.col <- "black"

rec_effort <- recdat %>% 
  filter(Var == "Recreational Effort") %>% 
  ggplot() + 
 #Highlight last ten years
  annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  geom_gls(aes(x = Time, y = Value,
               group = Var),
             alpha = trend.alpha, size = trend.size) +
  geom_line(aes(x = Time, y = Value, color = Var), size = lwd) +
  geom_point(aes(x = Time, y = Value, color = Var), size = pcex) +

  scale_x_continuous(expand = c(0.01, 0.01)) +
  scale_y_continuous(labels = function(l){trans = l / 1000000})+
  scale_color_manual(values = series.col, aesthetics = "color")+
  guides(color = FALSE) +
  ylab(expression(atop("Recreational effort"," (10"^6*" days fished)"))) +
  xlab("")+
  geom_hline(aes(yintercept = hline,
               color = Var),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
  theme_ts() 

rec_div <- recdat %>% 
  filter(Var == "Recreational fleet effort diversity across modes") %>% 
  ggplot() + 
 #Highlight last ten years
  annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  geom_gls(aes(x = Time, y = Value,
               group = Var),
             alpha = trend.alpha, size = trend.size) +
  geom_line(aes(x = Time, y = Value, color = Var), size = lwd) +
  geom_point(aes(x = Time, y = Value, color = Var), size = pcex) +

  scale_x_continuous(expand = c(0.01, 0.01)) +
  scale_color_manual(values = series.col, aesthetics = "color")+
  guides(color = FALSE) +
  ylab(expression("Effort diversity")) +
  xlab("")+
  geom_hline(aes(yintercept = hline,
               color = Var),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
  theme_ts()


rec_anglers <- recdat %>% 
  filter(Var == "Recreational anglers") %>% 
  ggplot() + 
 #Highlight last ten years
  annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  geom_gls(aes(x = Time, y = Value,
               group = Var),
             alpha = trend.alpha, size = trend.size) +
  geom_line(aes(x = Time, y = Value, color = Var), size = lwd) +
  geom_point(aes(x = Time, y = Value, color = Var), size = pcex) +

  scale_x_continuous(expand = c(0.01, 0.01)) +
  scale_y_continuous(labels = function(l){trans = l / 1000000})+
  scale_color_manual(values = series.col, aesthetics = "color")+
  guides(color = FALSE) +
  ylab(expression("Angler (10"^6*" n)")) +
  xlab("Time")+
  geom_hline(aes(yintercept = hline,
               color = Var),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
  theme_ts()



cowplot::plot_grid(rec_effort, rec_div, rec_anglers, ncol = 1, align = "hv") +
    theme(plot.margin = unit(c(0.1, 0, 0, 0), "cm"))
```

## Mariculture (Mid-Atlantic states)
<!-- This section is hard coded as it is not included in the New England report -->

Aquaculture indicators address both seafood production and possibly habitat objectives in that planted bivalves such as oysters provide both habitat structure and contribute locally to improved water quality at high densities. Individual states collect and report aquaculture data by surveying commercial farmers, and at this time, data in the Mid-Atlantic are available for Virginia, Maryland, and New Jersey (Fig. \ref{oyster-aqua}). From the reported data, Virginia is the largest producer of oysters, although oyster aquaculture is increasing overall throughout the Mid-Atlantic.

```{r oyster-aqua, fig.width = 5, fig.asp = 0.45, fig.cap = "Oyster aquaculture production in terms of number of oysters sold from Virginia, Maryland, and New Jersey. \\label{oyster-aqua}"}

aqua <- ecodata::aquaculture %>% 
  group_by(Var) %>% 
  mutate(hline = mean(Value)) %>%
  ungroup() %>% 
  mutate(Var = plyr::mapvalues(Var, from = c("md oyster harvest","nj oyster harvest","va oyster harvest"),
                                                    to  = c("MD","NJ","VA"))) %>%
  dplyr::rename(State = Var)

aqua$State <- factor(aqua$State, levels = c("VA","MD","NJ"))


ggplot() + 
  geom_segment(aes(x=2005,xend=2017,y=mean(aquaculture[aquaculture$Var == "va oyster harvest",]$Value),
                   yend=mean(aquaculture[aquaculture$Var == "va oyster harvest",]$Value)),
               size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty,
           color = "#1b9e77",
           inherit.aes = F) +
  geom_segment(aes(x=2012,xend=2016,y=mean(aquaculture[aquaculture$Var == "nj oyster harvest",]$Value),
                   yend=mean(aquaculture[aquaculture$Var == "nj oyster harvest",]$Value)),
               size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty,
           color = "#d95f02",
           inherit.aes = F) +
  geom_segment(aes(x=2012,xend=2017,y=mean(aquaculture[aquaculture$Var == "md oyster harvest",]$Value),
                   yend=mean(aquaculture[aquaculture$Var == "md oyster harvest",]$Value)),
               size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty,
           color = "#7570b3",
           inherit.aes = F) +
 #Highlight last ten years
  geom_line(data = aqua, aes(x = Time, y = Value, color = State), size = lwd) +
  geom_point(data = aqua,aes(x = Time, y = Value, color = State), size = pcex) +
  scale_color_manual(values = c(VA = "#1b9e77", MD = "#7570b3",NJ = "#d95f02")) +
  scale_x_continuous(breaks = seq(2005,2018,3),expand = c(0.01, 0.01)) +
  scale_y_continuous(labels = function(l){trans = l / 1000000})+
  ylab(expression("Oysters sold (10"^6*" n)")) +
  xlab("")+
  theme_ts()

```

## Water Quality

This section will include the water quality and nursey habitat indicators for Chesapeake Bay

## Social

```{r community-reliance, fig.cap = paste0("Fishing community reliance and engagement in commercial fisheries by state in the ",region,", where circle color reflects community reliance and engagement rankings (least reliant/engaged = 0; most reliant/engaged = 4), and circle size shows the percentage of sampled communities meeting different ranks. \\label{comm-eng-rel}"), fig.width = 8, fig.asp = 0.45, warning=F}
# Set lat/lon window for maps
xmin = -78
xmax = -70
ymin = 35
ymax = 42
xlims <- c(xmin, xmax)
ylims <- c(ymin, ymax)



int_join <- data.frame(STATEABBR = rep(unique(ecodata::eng_rel[ecodata::eng_rel$REGION == region,]$STATEABBR), each = 5),
                       Var = factor(0:4))


# eng_rel <- ecodata::eng_rel %>%
#  filter(PRIMARY_LATITUDE < 42) %>%
#   mutate(ComEng_NE16_ct = as.numeric.factor(ComEng_NE16_ct)) %>%
#   mutate(char_cat = ifelse(ComEng_NE16_ct > 2, "C",
#                            ifelse(ComEng_NE16_ct <= 2 & ComEng_NE16_ct > 1,"B","A")),
#          num_cat = ifelse(ComRel_NE16_ct > 2, 3,
#                           ifelse(ComRel_NE16_ct <= 2 & ComRel_NE16_ct >1,2,1))) %>%
#   unite(.,cat,c("char_cat","num_cat"), sep = "") %>%
#   dplyr::rename(Latitude = PRIMARY_LATITUDE,
#                 Longitude = PRIMARY_LONGITUDE) %>%
#   group_by(STATEABBR, cat) %>% 
#   summarise(n = n()) %>% 
#   mutate(freq = n / sum(n)) %>% 
#   filter(STATEABBR != "PA") %>% 
#   as.data.frame()  %>% 
#   right_join(.,int_join, by = c("STATEABBR","cat")) %>% 
#   mutate(freq = plyr::mapvalues(freq, from = NA, to = 0),
#          n = plyr::mapvalues(n, from = NA, to = 0))



rel <- ecodata::eng_rel %>% 
  filter(REGION == region) %>% 
  mutate(ComRel_NE16_ct = factor(ComRel_NE16_ct)) %>%
  dplyr::rename(Latitude = PRIMARY_LATITUDE,
                Longitude = PRIMARY_LONGITUDE,
                Var = ComRel_NE16_ct) %>% 
  group_by(STATEABBR, Var) %>% 
  dplyr::summarise(n = n()) %>% 
  right_join(.,int_join,by = c("STATEABBR","Var")) %>% 
  as.data.frame()

eng <- ecodata::eng_rel %>% 
  filter(REGION == region) %>% 
  dplyr::rename(Latitude = PRIMARY_LATITUDE,
                Longitude = PRIMARY_LONGITUDE,
                Var = ComEng_NE16_ct) %>% 
  group_by(STATEABBR, Var) %>% 
  dplyr::summarise(n = n()) %>% 
  right_join(.,int_join,by = c("STATEABBR","Var")) %>% 
  as.data.frame()
  

eng_rel <- rel %>%
  left_join(.,eng, by = c("STATEABBR","Var")) %>% 
  dplyr::rename(Reliance = n.x, Engagement = n.y) %>% 
  replace_na(list(Reliance = 0, Engagement = 0)) %>% 
  gather(.,Class,Value,-STATEABBR,-Var) %>%
  group_by(STATEABBR , Class) %>%
  mutate(freq = Value / sum(Value))

biv_col <- c("4" = "#ca0020", "3" = "#f4a582", "2" = "grey", "1" = "#92c5de", "0" = "#0571b0")

eng_rel %>% 
ggplot() +
#  geom_line(aes(x = Class, y = Value, group = Var, color = Var)) +
  geom_point(aes(x = Class, y = Var, size = freq, color = Var)) +
 scale_size(name = "Rank\nFrequency")+
  facet_wrap(.~STATEABBR, ncol = 4) +
  guides(color = guide_legend(override.aes = list(size = 5),
                              reverse = T)) + 
  scale_color_manual(name = "Ranking", values = biv_col) +
  # scale_x_discrete(expand = c(0.05, 0.05))+
  theme_ts() +
  theme(legend.key.size = unit(1,"mm")) +
  ylab("Community Ranking")+
  theme(strip.background = element_blank(),
        strip.text=element_text(),
        legend.position = c(1, 0), 
         legend.justification = c(1, 0.1),
        legend.box = "horizontal",legend.background = element_rect(color="grey",size = 0.05)) +
  ggtitle("Commercial Fishing Community Reliance and Engagement")

# biv_col <- c(A1 = "#e8e8e8", B1 = "#ace4e4", C1 = "#5ac8c8",
#              A2 = "#dfb0d6", B2 = "#a5add3", C2 = "#5698b9",
#              A3 = "#be64ac", B3 = "#8c62aa", C3 = "#3b4994")

# biv_df <- data.frame()
# r <- raster(xmn = -73.5, xmx = -71.4, ymn = 36, ymx = 37.8, nrows = 3, ncols = 3)
# r[] <- 1:9



# ggplot(data = eng_rel, aes(area = n, fill = cat)) +
#   geom_treemap(layout = "fixed") +
#   facet_wrap(STATEABBR~., ncol = 5) +
#   scale_fill_manual(values = biv_col)
# 
# glm(ComEng_NE16_ct ~ ComRel_NE16_ct, data = eng_rel, family = "poisson")

# biv_col <- c(A1 = "#e8e8e8", B1 = "#b5c0da", C1 = "#6c83b5",
#              A2 = "#b8d6be", B2 = "#90b2b3", C2 = "#567994",
#              A3 = "#73ae80", B3 = "#5a9178", C3 = "#2a5a5b")

# plot(r, col = biv_col, legend = F, bty = "n", axes = F, yaxt = "n", frame.plot = F,
#      xaxt='n', add = T)


# ggplot() +
#   geom_sf(data = coast, size = map.lwd) +
#   geom_sf(data  = ne_states, size = map.lwd) +
#   coord_sf(crs = crs, xlim = xlims, ylim = ylims) +
#   #geom_point(data = eng_rel, aes(x = Longitude, y = Latitude, color = cat)) +
#   scale_color_manual(values = biv_col) +
#   theme_map() +
#   xlab("Longitude") +
#   ylab("Latitude")
```


```{r rec-reliance, fig.cap = paste0("Fishing community reliance and engagement in commercial fisheries by state in ",region,", where circle color reflects community reliance and engagement rankings (least reliant/engaged = 0; most reliant/engaged = 4), and circle size shows the percentage of sampled communities meeting different ranks. \\label{rec-eng-rel}"), fig.width = 8, fig.asp = 0.45, warning=F}

rel <- ecodata::eng_rel %>% 
  filter(REGION == region) %>% 
  mutate(RecRel_NE16_ct = factor(RecRel_NE16_ct)) %>%
  dplyr::rename(Latitude = PRIMARY_LATITUDE,
                Longitude = PRIMARY_LONGITUDE,
                Var = RecRel_NE16_ct) %>% 
  group_by(STATEABBR, Var) %>% 
  dplyr::summarise(n = n()) %>% 
  right_join(.,int_join,by = c("STATEABBR","Var")) %>% 
  as.data.frame()

eng <- ecodata::eng_rel %>% 
  filter(REGION == region) %>% 
  mutate(RecEng_NE16_ct = factor(RecEng_NE16_ct)) %>%
  dplyr::rename(Latitude = PRIMARY_LATITUDE,
                Longitude = PRIMARY_LONGITUDE,
                Var = RecEng_NE16_ct) %>% 
  group_by(STATEABBR, Var) %>% 
  dplyr::summarise(n = n()) %>% 
  right_join(.,int_join,by = c("STATEABBR","Var")) %>% 
  as.data.frame()
  

eng_rel <- rel %>%
  left_join(.,eng, by = c("STATEABBR","Var")) %>% 
  dplyr::rename(Reliance = n.x, Engagement = n.y) %>% 
  replace_na(list(Reliance = 0, Engagement = 0)) %>% 
  gather(.,Class,Value,-STATEABBR,-Var) %>%
  group_by(STATEABBR , Class) %>%
  mutate(freq = Value / sum(Value))

biv_col <- c("4" = "#ca0020", "3" = "#f4a582", "2" = "grey", "1" = "#92c5de", "0" = "#0571b0")

eng_rel %>% 
ggplot() +
#  geom_line(aes(x = Class, y = Value, group = Var, color = Var)) +
  geom_point(aes(x = Class, y = Var, size = freq, color = Var)) +
 scale_size(name = "Rank\nFrequency")+
  facet_wrap(.~STATEABBR, ncol = 4) +
  guides(color = guide_legend(override.aes = list(size = 5),
                              reverse = T)) + 
  scale_color_manual(name = "Ranking", values = biv_col) +
  # scale_x_discrete(expand = c(0.05, 0.05))+
  theme_ts() +
  theme(legend.key.size = unit(1,"mm")) +
  ylab("Community Ranking")+
  theme(strip.background = element_blank(),
        strip.text=element_text(),
        legend.position = c(1, 0), 
         legend.justification = c(1, 0.1),
        legend.box = "horizontal",legend.background = element_rect(color="grey",size = 0.05)) +
  ggtitle("Recreational Fishing Community Reliance and Engagement")
```

# Protected species-fishery interactions

## Harbor porpoise (coastwide)

#### With a ribbon to show uncertainty

```{r harbor-porpoise-ribbon, fig.width = 5, fig.asp = 0.45, fig.cap = "Harbor porpoise bycatch estimate (black) shown with Potential Biological Removal (red). Line shading indicates 95\\% confidence interval."}

ecodata::harborporpoise %>% 
  spread(.,Var,Value) %>% 
ggplot() +
    annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  geom_line(aes(x = Time, y = `harbor porpoise bycatch estimate`, color = "Harbor Porpoise Bycatch"), size = lwd) +
  geom_point(aes(x = Time, y = `harbor porpoise bycatch estimate`, color = "Harbor Porpoise Bycatch"), size = pcex) +
  geom_ribbon(aes(x = Time,
                  ymin = `harbor porpoise bycatch lo95ci`,
                  ymax = `harbor porpoise bycatch up95ci`),
              alpha = hline.alpha) +
  geom_line(aes(x = Time, y = `harbor porpoise bycatch pbr`, color = "PBR"), size = lwd-0.1) +
  scale_color_manual("", values = c("Harbor Porpoise Bycatch" = "black", "PBR" = "red")) +
  guides(color = guide_legend(override.aes = list(shape = c(19,NA)))) +
  scale_x_continuous(expand = c(0.01, 0.01)) +
  ylab("Bycatch Estimate (n)") +
  theme_ts() +
  theme(legend.position = c(0.4, 0.85), legend.background = element_rect(
    fill = "transparent"), legend.text = element_text(size = 10))


```

#### With error bars 

```{r harbor-porpoise-bars, fig.width = 5, fig.asp = 0.45, fig.cap = "Harbor porpoise bycatch estimate (black) shown with Potential Biological Removal (red). Error bars indicate 95\\% confidence interval."}

ecodata::harborporpoise %>% 
  spread(.,Var,Value) %>% 
ggplot() +
    annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  geom_line(aes(x = Time, y = `harbor porpoise bycatch estimate`, color = "Harbor Porpoise Bycatch"), size = lwd) +
  geom_point(aes(x = Time, y = `harbor porpoise bycatch estimate`, color = "Harbor Porpoise Bycatch"), size = pcex) +
  geom_errorbar(aes(x = Time,
                    ymin = `harbor porpoise bycatch lo95ci`,
                  ymax = `harbor porpoise bycatch up95ci`,
                  color = "Harbor Porpoise Bycatch"), 
                width = 0.25)+
  geom_line(aes(x = Time, y = `harbor porpoise bycatch pbr`, color = "PBR"), size = lwd-0.1) +
  scale_color_manual("", values = c("Harbor Porpoise Bycatch" = "black", "PBR" = "red")) +
  guides(color = guide_legend(override.aes = list(shape = c(19,NA)))) +
  scale_x_continuous(expand = c(0.01, 0.01)) +
  ylab("Bycatch Estimate (n)") +
  theme_ts() +
  theme(legend.position = c(0.4, 0.85), legend.background = element_rect(
    fill = "transparent"), legend.text = element_text(size = 10))

```

## Right whale (coastwide)

```{r right-whale-errorbars, fig.cap = "Estimated North Atlanic right whale abundance. Error bars represent the 95\\% credible interval.", fig.width = 5, fig.asp = 0.45}

hline <- mean(narw[narw$Var == "right whale abundance median",]$Value)

ecodata::narw %>% 
  spread(.,Var,Value) %>% 
  ggplot() +
#Highlight last ten years
  annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  geom_line(aes(x = Time, y = `right whale abundance median`), size = lwd-0.75) +
  geom_point(aes(x = Time, y = `right whale abundance median`), size = pcex-0.75) +
  geom_errorbar(aes(x = Time,
                    ymin = `right whale abundance lcl`,
                  ymax = `right whale abundance ucl`), 
                width = 0.25) +
  scale_x_continuous(expand = c(0.01, 0.01)) +
  scale_color_manual(values = series.col, aesthetics = "color")+
  guides(color = FALSE) +
  ylab(expression("Abundance (n)")) +
  xlab("Time")+
  geom_hline(aes(yintercept = hline),
           color = "black",
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
  theme_ts()
```

```{r right-whale-ribbon, fig.cap = "Estimated North Atlanic right whale abundance. Line shading represents the 95\\% credible interval.", fig.width = 5, fig.asp = 0.45}

hline <- mean(narw[narw$Var == "right whale abundance median",]$Value)

ecodata::narw %>% 
  spread(.,Var,Value) %>% 
  ggplot() +
#Highlight last ten years
  annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  geom_line(aes(x = Time, y = `right whale abundance median`), size = lwd-0.75) +
  geom_point(aes(x = Time, y = `right whale abundance median`), size = pcex-0.75) +
  geom_ribbon(aes(x = Time,
                    ymin = `right whale abundance lcl`,
                  ymax = `right whale abundance ucl`),
              alpha = hline.alpha) +
  scale_x_continuous(expand = c(0.01, 0.01)) +
  scale_color_manual(values = series.col, aesthetics = "color")+
  guides(color = FALSE) +
  ylab(expression("Abundance (n)")) +
  xlab("Time")+
  geom_hline(aes(yintercept = hline),
           color = "black",
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
  theme_ts()
```

# Resource species (`r epu_abbr`)

Patterns for groups of species that feed on similar prey can indicate how overall ecosystem conditions are changing and provide context for individual species stock assessments. The information presented in Figure \ref{nefsc-biomass} is taken from NEEFSC bottom trawl surveys during the spring and fall. 

## Trends in biomass (`r epu_abbr`)

```{r nefsc-biomass, fig.cap = paste0("Fall (left) and spring (right) NEFSC survey biomass in the ",region,". \\label{nefsc-biomass}"), fig.width=8}


total_surv <- nefsc_survey %>% 
  filter(EPU == epu_abbr,
         !str_detect(Var, "Other|Apex|managed"),
         Time >= 1968) %>% 
  group_by(Var) %>% 
  mutate(hline = mean(Value)) %>% 
  ungroup() %>% 
  mutate(Var = word(Var, 1,2))

series.col <- rep("black",length(unique(total_surv$Var)))

total_surv$Var <- factor(total_surv$Var,levels = c("Piscivore Fall",
                                                   "Piscivore Spring",
                                                    "Benthivore Fall",
                                                    "Benthivore Spring",
                                                    "Planktivore Fall",
                                                    "Planktivore Spring",
                                                    "Benthos Fall",
                                                    "Benthos Spring"))

#Create dataframe for label locations
label_loc <- total_surv %>%
  group_by(Var) %>%
  dplyr::summarise(yloc = max(Value)*0.95,
                   xloc = min(Time)) %>% 
  mutate(label = LETTERS[1:8])

#facet names for titles
facet_names <- list("Piscivores" = expression("Piscivores"),
                    "Planktivores" = expression("Planktivores"),
                    "Benthivores" = expression("Benthivores"),
                    "Benthos" = expression("Benthos"))


ggplot(data = total_surv) +
  
  #Highlight last ten years
  annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  
  #Test for trend and add lines
  geom_gls(aes(x = Time, y = Value,
               color = Var),
             alpha = trend.alpha, size = trend.size) +
  
  #Add time series
  geom_line(aes(x = Time, y = Value, color = Var), size = lwd-0.5) +
  geom_point(aes(x = Time, y = Value, color = Var), size = pcex-0.5) +
  scale_color_manual(values = series.col, aesthetics = "color")+
  guides(color = FALSE) +
  geom_hline(aes(yintercept = hline,
                 group = Var),
             size = hline.size,
             alpha = hline.alpha,
             linetype = hline.lty)+

  #Facet 
  facet_wrap(Var~.,scales = "free_y", ncol = 2) +
  
  #Axis and theme
  scale_x_continuous(breaks = seq(1965, 2015, by = 10), expand = c(0.01, 0.01)) +
  ylab(expression("Biomass (kg tow"^-1*")")) +
  theme_facet()+
  theme(strip.text=element_text(hjust=0))

```

## Ichthyoplankton diversity (coastwide)

## Species distribution (coastwide)

Mean along-shelf distance, habitat area, and species distribution plots

# Ecosystem Conditions and Productivity

Productivity of the system can be influenced by many factors. Temperature affects the behavior and physiology of marine organisms while changes in productivity and species composition at the base of the food web can influence juvenile survival. In this section, we report temperature and lower trophic level production trends and annual cycles for the most recent year. We also look at fish productivity through recruitment and fish condition. 

## Long-term ocean temperature (coastwide)

Sea surface temperature (SST) measurements have been collected on the Northeast Continental Shelf since the mid-1800s. The highest mean annual temperature in this time series was recorded in 2012, as the ecosystem warmed above the levels last seen in the late 1940s. The 2018 datum is the **X** highest temperature in the time series. The positive trend over the full time series (1856-2018) is statistically significant, and the trend over the past decade is greater than the long-term average. 

**Figure here**

Annual cycles in ocean temperature and primary production (`r epu_abbr`)

**2018 SST figure here**

```{r primary-productivity, fig.width=8, fig.height = 4}

out_pp <- ecodata::chl_pp %>% 
  filter(EPU == epu_abbr,
         str_detect(Var, "MONTHLY_PPD_MEDIAN OC-CCI BERENFELD")) %>% 
  separate(.,Time, into = c("Year","Month"), sep = 4) %>% 
    mutate(Month = plyr::mapvalues(Month, from = c("01","02","03","04","05","06",
                                                   "07","08","09","10","11","12"),
                                   to = c(month.abb)))
out_pp$Month <- factor(out_pp$Month, levels = month.abb)


(pp_cci <- ggplot(out_pp) +
    geom_gls(aes(x = Year, y = Value, group = Month))+
    geom_point(aes(x = Year, y = Value, group = Month)) +
    geom_line(aes(x = Year, y = Value, group = Month)) +
    scale_x_discrete(name = "Time", breaks = seq(min(out_pp$Year),max(out_pp$Year),10)) +  
    facet_wrap(Month~., ncol = 6) +
    ggtitle("MONTHLY_PPD_MEDIAN OC-CCI BERENFELD") +
    theme_facet() +
    theme(axis.text.x = element_text(angle=45, hjust = 1),
          panel.spacing = unit(1, "lines"),
          plot.margin = unit(c(0.1, 0, 0, 0), "cm")))


# (chl_seawifs <- pp %>%
#   filter(str_detect(Var, "MONTHLY_CHLOR_A_MEDIAN SeaWiFS PAN")) %>% 
#   separate(.,Time, into = c("Year","Month"), sep = 4) %>% 
#   ggplot() +
#     geom_point(aes(x = Year, y = Value)) +
#     facet_wrap(Month~., ncol = 12) +
#     ggtitle("MONTHLY_CHLOR_A_MEDIAN SeaWiFS PAN"))


# (chl_modis <- pp %>%
#   filter(str_detect(Var, "MONTHLY_CHLOR_A_MEDIAN MODIS-Aqua PAN")) %>% 
#   separate(.,Time, into = c("Year","Month"), sep = 4) %>% 
#   ggplot() +
#     geom_point(aes(x = Year, y = Value)) +
#     facet_wrap(Month~., ncol = 12) +
#     ggtitle("MONTHLY_CHLOR_A_MEDIAN MODIS-Aqua PAN"))


# (pp_modis <- pp %>%
#   filter(str_detect(Var, "MONTHLY_PPD_MEDIAN MODIS-Aqua BERENFELD")) %>% 
#   separate(.,Time, into = c("Year","Month"), sep = 4) %>% 
#   ggplot() +
#     geom_point(aes(x = Year, y = Value)) +
#     facet_wrap(Month~., ncol = 12) +
#     ggtitle("MONTHLY_PPD_MEDIAN MODIS-Aqua BERENFELD"))
# 
# (pp_seawifs <- pp %>%
#   filter(str_detect(Var, "MONTHLY_PPD_MEDIAN SeaWiFS BERENFELD")) %>% 
#   separate(.,Time, into = c("Year","Month"), sep = 4) %>% 
#   ggplot() +
#     geom_point(aes(x = Year, y = Value)) +
#     geom_gls(aes(x = Year, y = Value, group = Month)) +
#     facet_wrap(Month~., ncol = 12) +
#     ggtitle("MONTHLY_PPD_MEDIAN SeaWiFS BERENFELD"))



```

```{r chl, fig.width = 8, fig.height=4}
out_chl <- ecodata::chl_pp %>% 
  filter(EPU == epu_abbr,
         str_detect(Var, "MONTHLY_CHLOR_A_MEDIAN OC-CCI PAN")) %>% 
  separate(.,Time, into = c("Year","Month"), sep = 4) %>% 
    mutate(Month = plyr::mapvalues(Month, from = c("01","02","03","04","05","06",
                                                   "07","08","09","10","11","12"),
                                   to = c(month.abb)))
out_chl$Month <- factor(out_chl$Month, levels = month.abb)


(chl_cci <- ggplot(out_chl) +
    geom_gls(aes(x = Year, y = Value, group = Month))+
    geom_point(aes(x = Year, y = Value, group = Month)) +
    geom_line(aes(x = Year, y = Value, group = Month)) +
    scale_x_discrete(name = "Time", breaks = seq(min(out_chl$Year),max(out_chl$Year),10)) +  
    facet_wrap(Month~., ncol = 6) +
    ggtitle("MONTHLY_CHLOR_A_MEDIAN OC-CCI PAN") +
    theme_facet() +
    theme(axis.text.x = element_text(angle=45, hjust = 1),
          panel.spacing = unit(1, "lines"),
          plot.margin = unit(c(0.1, 0, 0, 0), "cm")))

```

#Oceanography

```{r MAB-wind}



```

